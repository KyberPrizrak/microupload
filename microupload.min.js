/**
 * microupload.js
 *
 * Copyright (C) 2020 Konstantin A Chugunnyj (KyberPrizrak)
 *
 * LICENSE:
 *
 * This file is part of microlightbox.
 *
 * microlightbox is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * microlightbox is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with microlightbox. If not, see <http://www.gnu.org/licenses/>.
 *
 * @author KyberPrizrak (www.kyberprizrak.ru)
 * @version 0.1.5 - 2020.05.02 10:08:00 GMT+3
 */

(function(){function k(c,a){try{if("string"===typeof c){var e=document.querySelectorAll(c);for(c=0;c<e.length;c++)k(e[c],a)}else c.addEventListener("change",function(b){m(b.target.files,a)})}catch(b){}}function m(c,a){try{"object"!==typeof a&&(a={});"string"!==typeof a.url&&(a.url="/upload.php");"string"!==typeof a.name&&(a.name="file");0<a.preview_max_width||(a.preview_max_width=100);0<a.preview_max_height||(a.preview_max_height=100);"string"!==typeof a.cancel_text&&(a.cancel_text="&times;");"string"!==
typeof a.extensions&&(a.extensions="*");0<a.max_file_size||(a.max_file_size=0);for(var e=0;e<c.length;e++)n(c[e],a)}catch(b){alert("microupload error")}}function n(c,a){function e(b){if(a.onerror)a.onerror(b,c,h);d&&(d.className="microupload_item microupload_item_error")}var b=c.name.split(".");b=b[b.length-1].toLowerCase();if("*"!==a.extensions&&0>("|"+a.extensions.split(",").join("|").toLowerCase()+"|").indexOf("|"+b+"|"))e("extension");else if(0<a.max_file_size&&c.size>a.max_file_size)e("maxsize");
else{window.microupload_filenum||(window.microupload_filenum=0);var h="microupload_"+ ++window.microupload_filenum+"_"+Math.random().toString().substr(2,6);if(a.container){b=a.container;"string"===typeof b&&(b=document.querySelector(b));var d=document.createElement("div");d.id=h;d.className="microupload_item";b.appendChild(d);if(a.preview){var l=document.createElement("div");l.className="microupload_preview microupload_preview_empty";window.FileReader&&(b=new FileReader,b.onload=function(b){var c=
new Image;c.onload=function(){var b=c.width,d=c.height;if(0<b&&0<d){if(b>a.preview_max_width||d>a.preview_max_height){var e=a.preview_max_width/b,f=a.preview_max_height/d;f>e?(c.width=a.preview_max_width,c.height=Math.ceil(d*e)):d>a.preview_max_height&&(c.width=Math.ceil(b*f),c.height=a.preview_max_height)}l&&(l.className="microupload_preview",c.className="microupload_preview_img",l.appendChild(c))}};c.src=b.target.result},b.readAsDataURL(c));d.appendChild(l)}b=document.createElement("div");b.className=
"microupload_filename";b.innerText=c.name;d.appendChild(b);b=document.createElement("div");b.className="microupload_progress";d.appendChild(b);var g=document.createElement("div");g.className="microupload_progress_value";g.style.width="0";g.innerText="0%";b.appendChild(g);a.cancelable&&(b=document.createElement("div"),b.className="microupload_cancel",b.innerHTML=a.cancel_text,b.addEventListener("click",function(){d&&((a.ontrycancel?a.ontrycancel(c,h):1)?(f.abort(),d.parentElement.removeChild(d)):e("ontrycancel"))}),
d.appendChild(b))}if(a.onbeforesubmit&&!a.onbeforesubmit(c,h))e("onbeforesubmit");else{b=new FormData;b.append(a.name,c);if(a.data)for(var k in a.data)b.append(k,a.data[k]);var f=new XMLHttpRequest;f.open("POST",a.url,!0);f.onreadystatechange=function(){4==f.readyState&&(200==f.status?(a.oncomplete?a.oncomplete(c,h,f.responseText):1)?(g&&(g.innerText="100%"),d&&(d.className+=" microupload_item_complete")):e("oncomplete"):e("network"))};f.upload&&(f.upload.onprogress=function(b){if(b.lengthComputable&&
(b=b.loaded/b.total*100,g&&(g.style.width=Math.ceil(b)+"%",g.innerText=Math.ceil(b)+"%"),a.onprogress))a.onprogress(c,h,b)},f.upload.onerror=function(){e("network")});f.send(b)}}}window.microupload=k;window.microupload_addfiles=m})();
